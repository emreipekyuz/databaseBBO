<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bir Bulut Olsam | Pro CRM Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase/2.39.0/supabase.min.js"></script>
    <style>
        /* Modern Apple-Style UI & Bento Grid */
        :root {
            --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff;
            --text: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); }
        .app-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 2rem 0; position: fixed; height: 100vh; z-index: 100; }
        .logo { padding: 0 1.5rem 2rem; font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .nav-menu { list-style: none; }
        .nav-item { padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 0.8rem; cursor: pointer; transition: 0.2s; color: var(--text-muted); font-weight: 600; }
        .nav-item:hover { background: #f1f5f9; color: var(--primary); }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-right: 4px solid var(--primary); }

        /* Main Content */
        .main-content { margin-left: 260px; flex: 1; padding: 2.5rem; width: calc(100% - 260px); }
        .header { margin-bottom: 2rem; }
        .header h1 { font-size: 1.8rem; font-weight: 800; }

        /* Filters */
        .filter-bar { background: var(--surface); padding: 1.2rem; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center; }
        select { padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: 10px; outline: none; font-size: 0.9rem; }

        /* KPI & CRM Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .kpi-value { font-size: 2rem; font-weight: 800; margin-top: 0.5rem; }
        
        .person-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .person-card { background: var(--surface); padding: 1.5rem; border-radius: 16px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .person-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .avatar { width: 50px; height: 50px; border-radius: 12px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 1rem; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: white; width: 90%; max-width: 600px; border-radius: 20px; padding: 2rem; max-height: 80vh; overflow-y: auto; }
        .event-tag { display: inline-block; background: #f1f5f9; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; margin: 4px; font-weight: 600; border: 1px solid #e2e8f0; }

        .btn { padding: 0.6rem 1.2rem; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; gap: 0.5rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f1f5f9; color: var(--text); }
        
        #loadingBar { position: fixed; top: 0; left: 0; right: 0; height: 4px; background: var(--primary); transform: scaleX(0); transform-origin: left; transition: 0.3s; z-index: 2000; }
    </style>
</head>
<body>
    <div id="loadingBar"></div>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><i data-lucide="cloud"></i> <span>Bir Bulut</span></div>
            <ul class="nav-menu">
                <li class="nav-item active" data-view="dashboard"><i data-lucide="pie-chart"></i><span>Dashboard</span></li>
                <li class="nav-item" data-view="crm"><i data-lucide="contact-2"></i><span>CRM / Katılımcılar</span></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Dashboard</h1>
                <p id="pageSubtitle">Genel performans ve katılım verileri</p>
            </div>

            <div class="filter-bar">
                <select id="eventFilter"><option value="all">Tüm Etkinlikler</option></select>
                <select id="dateRangeFilter">
                    <option value="all">Tüm Zamanlar</option>
                    <option value="7">Son 7 Gün</option>
                    <option value="30">Son 30 Gün</option>
                </select>
                <button class="btn btn-secondary" id="refreshBtn"><i data-lucide="refresh-cw"></i>Yenile</button>
                <button class="btn btn-primary" id="exportBtn" style="margin-left:auto;"><i data-lucide="download"></i>CSV İndir</button>
            </div>

            <div class="kpi-grid">
                <div class="card"><div class="text-muted">Toplam Katılım</div><div class="kpi-value" id="totalAttendances">0</div></div>
                <div class="card"><div class="text-muted">Tekil Katılımcı (CRM)</div><div class="kpi-value" id="uniqueParticipants">0</div></div>
                <div class="card"><div class="text-muted">Aktif Etkinlikler</div><div class="kpi-value" id="activeEvents">0</div></div>
            </div>

            <div id="dashboardView">
                <div class="card">
                    <h3 style="margin-bottom:1rem;">Kayıt Trendi</h3>
                    <canvas id="trendChart" height="100"></canvas>
                </div>
            </div>

            <div id="crmView" style="display: none;">
                <div class="person-grid" id="personGrid"></div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 id="modalTitle">Detay</h2>
                <button id="modalClose" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iqrmitiszsyewgcsvuvs.supabase.co';
        const SUPABASE_ANON_KEY = 'EYJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Burayı Anon Key ile doldurun
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = { events: [], attendances: [], participants: [], trendChart: null };

        async function init() {
            lucide.createIcons();
            setupListeners();
            await loadData();
        }

        function setupListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const view = item.dataset.view;
                    document.getElementById('dashboardView').style.display = view === 'dashboard' ? 'block' : 'none';
                    document.getElementById('crmView').style.display = view === 'crm' ? 'block' : 'none';
                    if(view === 'crm') renderCRM();
                });
            });
            document.getElementById('refreshBtn').onclick = loadData;
            document.getElementById('eventFilter').onchange = applyFilters;
            document.getElementById('dateRangeFilter').onchange = applyFilters;
            document.getElementById('modalClose').onclick = () => document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('exportBtn').onclick = exportCSV;
        }

        async function loadData() {
            setLoading(true);
            try {
                const [ev, att, part] = await Promise.all([
                    sb.from('events').select('*'),
                    sb.from('attendances').select('*, events(title)').order('created_at', {ascending: false}),
                    sb.from('participants').select('*')
                ]);
                
                state.events = ev.data || [];
                state.attendances = att.data || [];
                state.participants = part.data || [];

                const filter = document.getElementById('eventFilter');
                filter.innerHTML = '<option value="all">Tüm Etkinlikler</option>' + 
                    state.events.map(e => `<option value="${e.id}">${e.title}</option>`).join('');
                
                applyFilters();
            } catch (err) { console.error(err); }
            setLoading(false);
        }

        function applyFilters() {
            const evId = document.getElementById('eventFilter').value;
            const days = document.getElementById('dateRangeFilter').value;
            
            let filtered = state.attendances;
            if(evId !== 'all') filtered = filtered.filter(a => a.event_id === evId);
            if(days !== 'all') {
                const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(a => new Date(a.created_at) > cutoff);
            }

            document.getElementById('totalAttendances').textContent = filtered.length;
            document.getElementById('uniqueParticipants').textContent = new Set(filtered.map(a => a.email)).size;
            document.getElementById('activeEvents').textContent = state.events.filter(e => e.is_active).length;

            renderTrend(filtered);
            if(document.querySelector('.nav-item.active').dataset.view === 'crm') renderCRM(filtered);
        }

        function renderTrend(data) {
            const ctx = document.getElementById('trendChart');
            const counts = {};
            data.forEach(a => {
                const d = new Date(a.created_at).toLocaleDateString('tr-TR');
                counts[d] = (counts[d] || 0) + 1;
            });
            const labels = Object.keys(counts).reverse();
            if(state.trendChart) state.trendChart.destroy();
            state.trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Kayıt', data: labels.map(l => counts[l]), borderColor: '#2563eb', fill: true, backgroundColor: 'rgba(37,99,235,0.1)', tension: 0.4 }] },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function renderCRM(data = state.attendances) {
            const grid = document.getElementById('personGrid');
            const groups = data.reduce((acc, curr) => {
                if(!acc[curr.email]) acc[curr.email] = { name: curr.full_name, email: curr.email, history: [] };
                acc[curr.email].history.push(curr);
                return acc;
            }, {});

            grid.innerHTML = Object.values(groups).map(p => `
                <div class="person-card" onclick="showDetail('${p.email}')">
                    <div class="avatar">${p.name[0]}</div>
                    <div style="font-weight:700;">${p.name}</div>
                    <div class="text-muted" style="font-size:0.8rem;">${p.email}</div>
                    <div style="margin-top:1rem; font-size:0.9rem;"><b>${p.history.length}</b> Etkinlik</div>
                </div>
            `).join('');
        }

        function showDetail(email) {
            const p = state.attendances.filter(a => a.email === email);
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div style="margin-bottom:1rem;"><b>E-posta:</b> ${email}</div>
                <div><b>Katıldığı Etkinlikler:</b></div>
                <div style="margin-top:0.5rem;">${p.map(a => `<span class="event-tag">${a.events?.title || 'Bilinmiyor'}</span>`).join('')}</div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function exportCSV() {
            const headers = "Ad Soyad,Email,Telefon,Etkinlik,Tarih\n";
            const rows = state.attendances.map(a => `${a.full_name},${a.email},${a.phone},${a.events?.title},${a.created_at}`).join("\n");
            const blob = new Blob([headers + rows], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "katilimci_listesi.csv";
            link.click();
        }

        function setLoading(active) {
            document.getElementById('loadingBar').style.transform = active ? 'scaleX(1)' : 'scaleX(0)';
        }

        init();
    </script>
</body>
</html>
