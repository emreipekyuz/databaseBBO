<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BBO | Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    /* ... (CSS Kodları - Aynı kaldı) ... */
    :root{
      --bg:#f6fbff;
      --card: rgba(255,255,255,.86);
      --text:#071a36;
      --muted: rgba(7,26,54,.62);
      --border: rgba(7,26,54,.10);
      --shadow: 0 18px 46px rgba(2,18,50,.12);
      --blue:#1d4ed8;
      --cyan:#06b6d4;
      --slate:#94a3b8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#b42318;
      --glass: blur(12px);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 720px at 16% 0%, rgba(29,78,216,.16), transparent 60%),
        radial-gradient(900px 560px at 84% 8%, rgba(6,182,212,.12), transparent 62%),
        var(--bg);
    }
    .hidden{display:none!important}
    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background: linear-gradient(135deg, rgba(29,78,216,.95), rgba(6,182,212,.95));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title{min-width:0}
    .title h1{margin:0;font-size:18px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title p{margin:2px 0 0;color:var(--muted);font-weight:800;font-size:12px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px; border-radius:14px; font-weight:950;
      color:#fff; background: var(--blue);
      box-shadow: 0 12px 26px rgba(29,78,216,.22);
    }
    .btn.secondary{background:var(--cyan); box-shadow: 0 12px 26px rgba(6,182,212,.20);}
    .btn.ghost{
      background: rgba(255,255,255,.72);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:950}
    .btn.danger{background: var(--bad); box-shadow: 0 12px 26px rgba(180,35,24,.18);}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: repeat(6, minmax(0,1fr));}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns: repeat(1, minmax(0,1fr));}
    }
    .col-12{grid-column: span 12;}
    .col-8{grid-column: span 8;}
    .col-6{grid-column: span 6;}
    .col-4{grid-column: span 4;}
    .col-3{grid-column: span 3;}
    .col-5{grid-column: span 5;}
    .col-7{grid-column: span 7;}
    @media (max-width: 980px){
      .col-8,.col-7,.col-5{grid-column: span 6;}
      .col-4,.col-3{grid-column: span 3;}
      .col-12{grid-column: span 6;}
    }
    @media (max-width: 560px){
      .col-8,.col-7,.col-6,.col-5,.col-4,.col-3,.col-12{grid-column: span 1;}
    }

    .pad{padding:14px;}
    .kpi .label{font-size:12px;color:var(--muted);font-weight:950;margin-bottom:6px}
    .kpi .value{font-size:24px;font-weight:1000;letter-spacing:-.4px}
    .kpi .sub{margin-top:6px;font-size:12px;color:var(--muted);font-weight:900}

    .chipRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      font-weight:950; font-size:13px;
      min-height:42px;
    }
    .chip input[type="checkbox"]{width:18px;height:18px}
    .grow{flex:1;min-width:220px}
    .input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      font-weight:950;
      color: var(--text);
    }
    .status{
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      font-weight:950;font-size:13px;color:var(--muted);
      min-height:42px;
      display:flex;align-items:center;
    }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .sectionTitle h2{margin:0;font-size:14px;font-weight:1000}
    .sectionTitle p{margin:2px 0 0;font-size:12px;color:var(--muted);font-weight:900}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:1000;
      border:1px solid rgba(29,78,216,.18);
      background: rgba(29,78,216,.10);
      white-space:nowrap;
    }
    .pill.good{border-color:rgba(22,163,74,.22); background: rgba(22,163,74,.12)}
    .pill.warn{border-color:rgba(245,158,11,.28); background: rgba(245,158,11,.14)}
    .pill.bad{border-color:rgba(180,35,24,.22); background: rgba(180,35,24,.12)}
    .pill.gray{border-color:rgba(148,163,184,.25); background: rgba(148,163,184,.14)}

    .projects{display:flex;flex-direction:column;gap:12px}
    .projectCard{padding:14px}
    .projectHead{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:10px;
    }
    .projectName{margin:0;font-size:15px;font-weight:1000}
    .projectMeta{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .eventList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .eventRow{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px; border-radius:16px;
      border:1px solid rgba(7,26,54,.10);
      background: rgba(255,255,255,.74);
    }
    .eventLeft{min-width:0}
    .eventTitle{margin:0 0 4px;font-weight:1000;font-size:14px}
    .eventSmall{font-size:12px;color:var(--muted);font-weight:900;display:flex;gap:10px;flex-wrap:wrap}
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:1000;
      color:#fff; background: var(--blue);
      white-space:nowrap;
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.inactive{background: var(--slate);}
    .badge.good{background: var(--good);}

    .empty{
      padding:12px; border-radius:16px;
      border:1px dashed rgba(7,26,54,.22);
      background: rgba(255,255,255,.55);
      color:var(--muted); font-weight:950; font-size:13px;
    }

    /* HEATMAP */
    .heat{
      width:100%;
      border-collapse:separate;
      border-spacing:6px;
      table-layout:fixed;
    }
    .heat th,.heat td{
      font-size:11px; font-weight:950; color:var(--muted);
      text-align:center;
    }
    .cell{
      border:1px solid rgba(7,26,54,.10);
      border-radius:12px;
      height:34px;
      background: rgba(29,78,216,.06);
      color: var(--text);
      font-weight:1000;
      display:flex;align-items:center;justify-content:center;
    }

    /* Drawer (Event detail) */
    .drawerMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.28);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .drawerMask.show{display:flex;}
    .drawer{
      width:min(980px, 100%);
      max-height:86vh;
      overflow:hidden;
      border-radius: 22px;
      position:relative;
    }
    .drawerHeader{
      padding:14px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      background: var(--card);
      backdrop-filter: var(--glass);
    }
    .drawerBody{
      padding:14px;
      overflow:auto;
      max-height: calc(86vh - 64px);
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
    }
    .table th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      padding:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.80);
      position:sticky; top:0;
      backdrop-filter: var(--glass);
    }
    .table td{
      padding:10px;
      font-size:13px;
      font-weight:900;
      border-bottom:1px solid rgba(7,26,54,.08);
    }
    .table tr:last-child td{border-bottom:none;}
    .table td a{
      color:var(--blue);
      text-decoration:none;
      font-weight:1000;
    }

    /* Auth gate */
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;}
    .pinCard{max-width:400px;width:100%;padding:18px;}
    .pinCard h3{margin:0 0 10px;font-size:18px}
    .pinNote{min-height:18px;margin-top:8px;font-size:12px;font-weight:1000;color:var(--bad);}
    .pinInput{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(7,26,54,.16);
      font-weight:1000;
      outline:none;
      background:#fff;
    }
    .pinInput:focus{border-color: rgba(29,78,216,.55); box-shadow:0 0 0 4px rgba(29,78,216,.12);}

    /* Skeleton */
    .skeleton{
      position:relative;
      overflow:hidden;
      background: rgba(255,255,255,.55);
    }
    .skeleton::after{
      content:"";
      position:absolute; inset:0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(29,78,216,.10), transparent);
      animation: sh 1.1s infinite;
    }
    @keyframes sh{
      to{transform: translateX(100%);}
    }
  </style>
</head>

<body>
  <div id="pinScreen" class="center">
    <div class="card pinCard">
      <div class="brand" style="margin-bottom:10px;">
        <div class="logo"></div>
        <div class="title">
          <h1>Yönetici Girişi</h1>
          <p>Dashboard'a erişim için Supabase Auth kullanın</p>
        </div>
      </div>
      
      <input id="emailInput" class="pinInput" type="email" placeholder="E-posta" style="margin-bottom:10px;" />
      <input id="passwordInput" class="pinInput" type="password" placeholder="Şifre" />

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="loginBtn" style="flex:1;">Giriş Yap</button>
      </div>
      <div class="pinNote" id="pinNote"></div>
      <div class="muted" style="font-weight:900;font-size:12px;margin-top:10px;">
        Not: Dashboard'a erişim sadece yetkili yöneticilere açıktır.
      </div>
    </div>
  </div>

  <div id="dashboardContent" class="wrap hidden">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Bir Bulut Olsam · Etkinlik Dashboard</h1>
          <p>Proje → Etkinlik → Katılımcı · Analiz + operasyon</p>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="reloadBtn">Yenile</button>
        <button class="btn secondary" id="logoutBtn">Çıkış Yap</button>
      </div>
    </div>

    <div class="card pad" style="margin-bottom:12px;">
      <div class="chipRow">
        <div class="chip grow">
          <span>Arama</span>
          <input id="search" class="input" placeholder="Proje / etkinlik / kod ara" />
        </div>

        <div class="chip">
          <span>Zaman</span>
          <select id="range" class="input" style="min-width:150px;font-weight:1000;">
            <option value="7">Son 7 gün</option>
            <option value="30" selected>Son 30 gün</option>
            <option value="90">Son 90 gün</option>
            <option value="365">Son 1 yıl</option>
          </select>
        </div>

        <label class="chip" style="cursor:pointer;">
          <input type="checkbox" id="onlyActive" />
          <span>Sadece aktif etkinlikler</span>
        </label>
        
        <button class="btn danger small" id="csvFilteredBtn" style="background:#b42318;">
            <span id="csvCount">—</span> Filtreli Kayıt İndir
        </button>
        
        <div class="status" id="status">Hazır</div>
      </div>
    </div>

    <div class="grid">
      <div class="card pad kpi col-4">
        <div class="label">Toplam check-in</div>
        <div class="value" id="kpiTotal">—</div>
        <div class="sub" id="kpiTotalSub">Seçilen aralık</div>
      </div>
      
      <div class="card pad kpi col-4">
        <div class="label">Bugün check-in</div>
        <div class="value" id="kpiToday">—</div>
        <div class="sub">Bugüne özel</div>
      </div>

      <div class="card pad kpi col-4">
        <div class="label">Aktif etkinlik</div>
        <div class="value" id="kpiActive">—</div>
        <div class="sub">Şu an açık</div>
      </div>
      
      </div>

    <div class="grid">
      <div class="card pad col-8">
        <div class="sectionTitle">
          <div>
            <h2>Günlük check-in trendi</h2>
            <p>Topluluğun ivmesi: yükseliyor mu, düşüyor mu?</p>
          </div>
          <span class="pill gray" id="trendTag">—</span>
        </div>
        <canvas id="chartDaily" height="120"></canvas>
      </div>

      <div class="card pad col-4">
        <div class="sectionTitle">
          <div>
            <h2>Hafta içi / saat ısı haritası</h2>
            <p>Operasyon: pik saatleri gör</p>
          </div>
          <span class="pill gray" id="peakTag">—</span>
        </div>
        <div id="heatWrap"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card pad col-6">
        <div class="sectionTitle">
          <div>
            <h2>Etkinlik bazlı katılım (Top 12)</h2>
            <p>Hangi etkinlik gerçekten çalışıyor?</p>
          </div>
        </div>
        <canvas id="chartTopEvents" height="140"></canvas>
      </div>

      <div class="card pad col-6">
        <div class="sectionTitle">
          <div>
            <h2>Yeni vs geri gelen</h2>
            <p>Gerçek büyüme mi, aynı çekirdek mi?</p>
          </div>
          <span class="pill gray" id="retentionTag">—</span>
        </div>
        <canvas id="chartNewReturning" height="140"></canvas>
      </div>
    </div>

    <div class="grid">
      <div class="card pad col-7">
        <div class="sectionTitle">
          <div>
            <h2>Operasyon modu: açık etkinlikler</h2>
            <p>Tek bakış: kod, QR link, son check-in</p>
          </div>
          <span class="pill good" id="activeCountTag">—</span>
        </div>
        <div id="activeEvents" class="projects"></div>
      </div>

      <div class="card pad col-5">
        <div class="sectionTitle">
          <div>
            <h2>Kalite kontrol</h2>
            <p>Kötü veri = çöp karar. Burayı hafife alma.</p>
          </div>
          <span class="pill warn" id="qcTag">—</span>
        </div>
        <div id="qcList"></div>

        <div style="height:10px"></div>

        <div class="sectionTitle">
          <div>
            <h2>Çapraz katılım matrisi (Top 6 proje)</h2>
            <p>Hangi proje birbirine trafik taşıyor?</p>
          </div>
        </div>
        <div id="crossWrap"></div>
      </div>
    </div>

    <div class="card pad">
      <div class="sectionTitle">
        <div>
          <h2>Projeler → Etkinlikler</h2>
          <p>Katılım, aktiflik, son check-in, performans etiketi</p>
        </div>
        <span class="pill gray" id="shownTag">—</span>
      </div>
      <div id="projects" class="projects"></div>
    </div>
  </div>

  <div id="drawerMask" class="drawerMask" aria-hidden="true">
    <div class="card drawer" role="dialog" aria-modal="true">
      <div id="drawerContent">
          </div>
    </div>
  </div>

<script>
/* =========================
   0) CONFIG (KENDİ SUPABASE BİLGİLERİNİZİ GİRİN)
========================= */
// Lütfen burayı kendi bilgilerinizle güncelleyin
const SUPABASE_URL = "https://iqrmitiszsyewgcsvuvs.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxcm1pdGlzenN5ZXdnY3N2dXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjE1OTQsImV4cCI6MjA4MTQzNzU5NH0.CnPYY4o9nkPVRQ1Uk9A4o231osvmtKsmxXH2ClDiabc";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   1) STATE & DOM & UTILS
========================= */
const state = {
  days: 30,
  search: "",
  onlyActive: false,
  projects: [],
  events: [],
  attendances: [],
  byEvent: new Map(),
  byProject: new Map(),
  charts: { daily:null, topEvents:null, newReturning:null },
  drawer: { event:null, rows:[] },
  // CRM ÖZELLİKLERİ KALDIRILDI
  filteredAttendances: [], 
};

const $ = (id) => document.getElementById(id);
const loginBtn = $("loginBtn");
const emailInput = $("emailInput");
const passwordInput = $("passwordInput");
const pinNote = $("pinNote");
const pinScreen = $("pinScreen");
const dashboardContent = $("dashboardContent");
const logoutBtn = $("logoutBtn");
const drawerMask = $("drawerMask");
const drawerContent = $("drawerContent");


function setStatus(t){ $("status").textContent = t; }
function setNote(t){ pinNote.textContent = t; }

function toggleViews(showDash) {
    if (showDash) {
        pinScreen.classList.add("hidden");
        dashboardContent.classList.remove("hidden");
    } else {
        pinScreen.classList.remove("hidden");
        dashboardContent.classList.add("hidden");
    }
}

function escapeHtml(str){
  return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function fmtTR(n){ return (Number(n)||0).toLocaleString("tr-TR"); }

function toISOStartOfDay(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x.toISOString();
}
function toISOStartDaysAgo(days){
  const d = new Date();
  d.setDate(d.getDate() - days);
  return toISOStartOfDay(d);
}
function isValidEmail(e){
  if(!e) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).trim().toLowerCase());
}
function normPhone(p){
  if(!p) return "";
  return String(p||"").replace(/[^\d+]/g,"").replace(/^00/,"+");
}
function normEmail(e){
  return String(e||"").trim().toLowerCase();
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* =========================
   2) SUPABASE AUTH GATE
========================= */

function lock(){
    sb.auth.signOut().then(() => {
        sessionStorage.removeItem("bbo_dash_ok");
        location.reload();
    }).catch(err => {
        console.error("Çıkış hatası:", err);
        setStatus("Hata: Çıkış yapılamadı");
    });
}

function unlock(){
    toggleViews(true);
    sessionStorage.setItem("bbo_dash_ok", "true");
    loadAll(); 
}

async function handleLogin(e) {
    e.preventDefault();

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
        setNote("E-posta ve şifre zorunludur.");
        return;
    }

    setNote("Giriş yapılıyor...");
    loginBtn.disabled = true;

    const { error } = await sb.auth.signInWithPassword({ email, password });

    if (error) {
        console.error(error.message);
        setNote("Giriş Başarısız: E-posta veya şifre hatalı.");
        loginBtn.disabled = false;
        return;
    }

    setNote("Giriş Başarılı.");
    unlock();
}

if(loginBtn) loginBtn.addEventListener("click", handleLogin);
if(logoutBtn) logoutBtn.addEventListener("click", lock);
if($("reloadBtn")) $("reloadBtn").addEventListener("click", loadAll);

/* =========================
   3) OTURUM KONTROLÜ
========================= */

function checkSessionAndInit() {
    sb.auth.getSession().then(({ data: { session } }) => {
        if (session && sessionStorage.getItem("bbo_dash_ok") === "true") {
            unlock();
        } else {
            toggleViews(false);
            setNote("");
            if(loginBtn) loginBtn.disabled = false;
        }
    });
}

checkSessionAndInit();

/* =========================
   4) DATA LOADING (CRM KALDIRILDI)
========================= */

async function fetchAll(){
    setStatus("Veri çekiliyor…");

    const sinceISO = toISOStartDaysAgo(state.days);

    // projects sorgusu
    const pRes = await sb.from("projects").select("id, name, is_active").order("name",{ascending:true});
    if(pRes.error) throw pRes.error;

    // events sorgusu
    const eRes = await sb.from("events").select("id, project_id, title, code, is_active, created_at").order("created_at",{ascending:false});
    if(eRes.error) throw eRes.error;

    // attendances sorgusu (participant_id çekimi kaldırıldı)
    const aRes = await sb
      .from("attendances")
      .select("id, event_id, full_name, phone, email, kvkk_consent, created_at")
      .gte("created_at", sinceISO)
      .order("created_at", { ascending: false })
      .limit(5000);

    if(aRes.error) throw aRes.error;

    // CRM verisi çekimi kaldırıldı.
    // state.uniqueParticipantsCount = 0; 


    state.projects = pRes.data || [];
    state.events = eRes.data || [];
    state.attendances = aRes.data || [];

    // maps
    state.byProject = new Map(state.projects.map(p => [p.id, p]));
    state.byEvent = new Map(state.events.map(e => [e.id, e]));
}

function buildAggregates(){
    const eventStats = new Map();
    const projectStats = new Map();
    const todayISO = toISOStartOfDay(new Date());
    let todayCount = 0;
    
    // Tekil kişi sayısını email/phone üzerinden hesaplama (CRM olmadan)
    const allUniqueAttendees = new Set(); 

    for(const a of state.attendances){
        if(a.created_at >= todayISO) todayCount++;

        const e = state.byEvent.get(a.event_id);
        if(!e) continue;

        const evId = e.id;
        if(!eventStats.has(evId)){
            eventStats.set(evId, {
                event_id: evId,
                count:0,
                last: null,
                kvkkNo:0,
                badEmail:0,
                badPhone:0,
                people: new Set(),
            });
        }
        const s = eventStats.get(evId);
        s.count++;
        if(!s.last || a.created_at > s.last) s.last = a.created_at;

        const kv = !!a.kvkk_consent; 
        if(!kv) s.kvkkNo++;

        const em = normEmail(a.email);
        if(!isValidEmail(em)) s.badEmail++;

        const ph = normPhone(a.phone);
        const digits = ph.replace(/[^\d]/g,"");
        if(digits.length < 10) s.badPhone++;

        // Tekil kişi tespiti (CRM olmadığından, email/phone hash'i kullanıyoruz)
        const fp = em || ph || (a.full_name || "").trim().toLowerCase();
        if(fp) s.people.add(fp);
        if(fp) allUniqueAttendees.add(fp);

        const prId = e.project_id;
        if(!projectStats.has(prId)){
            projectStats.set(prId, {
                project_id: prId,
                count:0,
                events: new Set(),
                last:null,
                people: new Set(),
            });
        }
        const ps = projectStats.get(prId);
        ps.count++;
        ps.events.add(evId);
        if(!ps.last || a.created_at > ps.last) ps.last = a.created_at;
        if(fp) ps.people.add(fp);
    }

    const enrichedEvents = state.events.map(ev => {
        const st = eventStats.get(ev.id) || {count:0,last:null,kvkkNo:0,badEmail:0,badPhone:0,people:new Set()};
        return {
            ...ev,
            event_title: ev.title, 
            event_code: ev.code,   
            attendee_count: st.count,
            last_checkin_at: st.last,
            qc: { kvkkNo: st.kvkkNo, badEmail: st.badEmail, badPhone: st.badPhone },
            uniq_people: st.people.size
        };
    });

    const enrichedProjects = state.projects.map(p => {
        const ps = projectStats.get(p.id) || {count:0,events:new Set(),last:null,people:new Set()};
        const evCount = ps.events.size;
        return {
            ...p,
            project_name: p.name, 
            attendee_count: ps.count,
            events_count: evCount,
            last_checkin_at: ps.last,
            uniq_people: ps.people.size
        };
    });

    return { enrichedEvents, enrichedProjects, todayCount, allUniqueAttendeesCount: allUniqueAttendees.size };
}

/* =========================
   5) ANALYTICS
========================= */
function computeForecastSameWeekday(){
  // Forecast KPI'ı şimdilik kaldırıldığı için basitleştirildi
  return 0; 
}

function dailySeries(){
  const n = state.days;
  const map = new Map(); 
  const today = new Date(); today.setHours(0,0,0,0);

  for(let i=n-1;i>=0;i--){
    const d = new Date(today); d.setDate(d.getDate()-i);
    const k = d.toISOString().slice(0,10);
    map.set(k, 0);
  }
  for(const a of state.attendances){
    const k = String(a.created_at).slice(0,10);
    if(map.has(k)) map.set(k, map.get(k)+1);
  }
  const labels = [...map.keys()];
  const values = labels.map(k => map.get(k));
  return { labels, values };
}

function heatmapWeekdayHour(){
  const grid = Array.from({length:7},()=>Array.from({length:24},()=>0));
  for(const a of state.attendances){
    const d = new Date(a.created_at);
    const wd = d.getDay();
    const hr = d.getHours();
    grid[wd][hr] += 1;
  }
  let peak = {wd:0,hr:0,val:0};
  for(let w=0;w<7;w++){
    for(let h=0;h<24;h++){
      const v = grid[w][h];
      if(v>peak.val) peak = {wd:w,hr:h,val:v};
    }
  }
  return { grid, peak };
}

function topEventsSeries(enrichedEvents){
  const arr = [...enrichedEvents].sort((a,b)=>(b.attendee_count||0)-(a.attendee_count||0)).slice(0,12);
  return {
    labels: arr.map(e => e.event_title || "Etkinlik"),
    values: arr.map(e => e.attendee_count || 0),
    rows: arr
  };
}

function newReturningSeries(){
  // CRM olmadığı için, basit ve yaklaşık bir tekil/tekrar tespiti yapıyoruz (email/phone bazında)
  const seen = new Map();
  let newCount = 0;
  let returningCount = 0;

  const rows = [...state.attendances].sort((a,b)=>a.created_at.localeCompare(b.created_at));

  for(const a of rows){
    const fp = normEmail(a.email) || normPhone(a.phone); // Tekil tanımlayıcı

    if(!fp) continue; // Geçersiz kayıtları atla
    
    if(seen.has(fp)) returningCount++;
    else { seen.set(fp, true); newCount++; }
  }

  return { newCount, returningCount };
}

function crossParticipationTopProjects(enrichedEvents, enrichedProjects){
  const top = [...enrichedProjects].sort((a,b)=>(b.attendee_count||0)-(a.attendee_count||0)).slice(0,6);

  // Email/Phone hash'i üzerinden tekillik sağlanır
  const projPeople = new Map(top.map(p=>[p.id, new Set()]));
  for(const a of state.attendances){
    const ev = state.byEvent.get(a.event_id);
    if(!ev) continue;
    if(!projPeople.has(ev.project_id)) continue;
    const fp = normEmail(a.email) || normPhone(a.phone);
    if(fp) projPeople.get(ev.project_id).add(fp);
  }

  const names = top.map(p=>p.project_name || "Proje");
  const ids = top.map(p=>p.id);
  const mat = Array.from({length:ids.length},()=>Array.from({length:ids.length},()=>0));

  for(let i=0;i<ids.length;i++){
    for(let j=0;j<ids.length;j++){
      if(i===j){ mat[i][j] = projPeople.get(ids[i]).size; continue; }
      const A = projPeople.get(ids[i]);
      const B = projPeople.get(ids[j]);
      let inter = 0;
      const [S,L] = A.size < B.size ? [A,B] : [B,A];
      for(const x of S) if(L.has(x)) inter++;
      mat[i][j] = inter;
    }
  }
  return { names, mat };
}

function performanceTag(event){
  if(!event.attendee_count) return {label:"Yeni / boş", cls:"gray"};
  if(event.is_active && event.attendee_count >= 30) return {label:"Güçlü", cls:"good"};
  if(event.is_active && event.attendee_count >= 10) return {label:"Stabil", cls:"warn"};
  if(event.is_active) return {label:"Zayıf", cls:"warn"};
  return {label:"Kapalı", cls:"gray"};
}

/* =========================
   6) RENDER (TEMİZLENMİŞ KPI'LAR VE RENDER LOGİĞİ)
========================= */
function renderKPIs({enrichedEvents, enrichedProjects, todayCount}){
  const total = state.attendances.length;
  $("kpiTotal").textContent = fmtTR(total);
  $("kpiToday").textContent = fmtTR(todayCount);
  // KPI TEKİL KİŞİ SAYISI KALDIRILDI
  // $("kpiUniq").textContent = fmtTR(state.uniqueParticipantsCount);

  const activeEvents = enrichedEvents.filter(e=>e.is_active===true).length;
  $("kpiActive").textContent = fmtTR(activeEvents);

  // FORECAST KPI'I KALDIRILDI
  // const fc = computeForecastSameWeekday();
  // $("kpiForecast").textContent = fmtTR(fc);

  const s = dailySeries().values;
  const last7 = s.slice(-7).reduce((a,b)=>a+b,0);
  const prev7 = s.slice(-14,-7).reduce((a,b)=>a+b,0);
  let tag = "Stabil";
  if(last7 > prev7 * 1.15) tag = "Yükselişte";
  if(last7 < prev7 * 0.85) tag = "Düşüşte";
  $("trendTag").textContent = `Trend: ${tag}`;
  
  // CSV butonundaki kayıt sayacını güncelle
  $("csvCount").textContent = `${fmtTR(state.filteredAttendances.length)}`;
}

function renderDailyChart(){
  const {labels, values} = dailySeries();
  const ctx = $("chartDaily").getContext("2d");

  if(state.charts.daily) state.charts.daily.destroy();
  state.charts.daily = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Check-in",
        data: values,
        tension: 0.25,
        fill: true,
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display:false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: true }
      }
    }
  });
}
// ... (Diğer render fonksiyonları aynı kaldı)

function renderHeatmap(){
  const {grid, peak} = heatmapWeekdayHour();
  const wdNames = ["Paz","Pzt","Sal","Çar","Per","Cum","Cmt"];
  const max = Math.max(1, ...grid.flat());
  const hours = [...Array(24)].map((_,i)=>i);

  $("peakTag").textContent = peak.val
    ? `Pik: ${wdNames[peak.wd]} ${String(peak.hr).padStart(2,"0")}:00 (${peak.val})`
    : "Pik: —";

  let html = `<table class="heat"><thead><tr><th></th>`;
  for(const h of hours){
    if(h%3===0) html += `<th>${h}</th>`;
    else html += `<th></th>`;
  }
  html += `</tr></thead><tbody>`;

  for(let w=0;w<7;w++){
    html += `<tr><th>${wdNames[w]}</th>`;
    for(let h=0;h<24;h++){
      const v = grid[w][h];
      const intensity = v / max; 
      const bg = `rgba(29,78,216, ${0.06 + 0.34*intensity})`;
      const br = `rgba(7,26,54, ${0.08 + 0.16*intensity})`;
      const color = intensity > 0.55 ? "rgba(255,255,255,.96)" : "var(--text)";
      html += `<td><div class="cell" style="background:${bg};border-color:${br};color:${color}">${v||""}</div></td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;

  $("heatWrap").innerHTML = html;
}

function renderTopEventsChart(enrichedEvents){
  const {labels, values} = topEventsSeries(enrichedEvents);
  const ctx = $("chartTopEvents").getContext("2d");
  if(state.charts.topEvents) state.charts.topEvents.destroy();

  state.charts.topEvents = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets:[{ label:"Katılım", data: values, borderWidth:1 }] },
    options: {
      responsive: true,
      plugins: { legend:{display:false} },
      scales: { y: { beginAtZero:true } }
    }
  });
}

function renderNewReturningChart(){
  const {newCount, returningCount} = newReturningSeries();
  // Hesaplama artık sadece email/phone hash'ine dayalı
  $("retentionTag").textContent = `Geri gelen oranı: ${newCount+returningCount ? Math.round(100*returningCount/(newCount+returningCount)) : 0}%`;

  const ctx = $("chartNewReturning").getContext("2d");
  if(state.charts.newReturning) state.charts.newReturning.destroy();

  state.charts.newReturning = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Yeni (aralık içi)", "Tekrar (aralık içi)"],
      datasets: [{ data: [newCount, returningCount] }]
    },
    options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
  });
}

function renderQC(enrichedEvents){
  let kvkkNo = 0, badEmail = 0, badPhone = 0;
  // Tekrarlılık CRM'siz hesaplanıyor
  const possibleDup = new Map(); 

  for(const a of state.attendances){
    if(!a.kvkk_consent) kvkkNo++; 
    
    const em = normEmail(a.email);
    if(!isValidEmail(em)) badEmail++;
    const ph = normPhone(a.phone);
    const digits = ph.replace(/[^\d]/g,"");
    if(digits.length < 10) badPhone++;

    // Tekrarlılık tespiti (email/phone hash'i üzerinden)
    const fp = em || ph;
    if(fp){
      possibleDup.set(fp, (possibleDup.get(fp)||0)+1);
    }
  }

  const dupCount = [...possibleDup.values()].filter(c=>c>=2).length;

  const items = [
    {label:"KVKK onayı olmayan kayıt", val: kvkkNo, sev: kvkkNo? "bad":"good"},
    {label:"Email format hatası", val: badEmail, sev: badEmail? "warn":"good"},
    {label:"Telefon format hatası", val: badPhone, sev: badPhone? "warn":"good"},
    {label:"Mükerrer katılımcı (aralık içi)", val: dupCount, sev: dupCount? "warn":"good"},
  ];

  const sevPill = (sev,txt)=> `<span class="pill ${sev}">${txt}</span>`;

  $("qcTag").textContent = `Alarm: ${items.filter(x=>x.val>0 && x.sev!=="good").length}`;

  let html = `<div class="projects" style="gap:8px;">`;
  for(const it of items){
    const p = it.sev==="bad" ? sevPill("bad","Kritik") : (it.sev==="warn" ? sevPill("warn","Dikkat") : sevPill("good","Temiz"));
    html += `
      <div class="eventRow">
        <div class="eventLeft">
          <div style="font-weight:1000;">${escapeHtml(it.label)}</div>
          <div class="muted" style="font-weight:900;font-size:12px;margin-top:3px;">Seçilen aralık</div>
        </div>
        <div class="row">
          ${p}
          <span class="badge ${it.val? "":"inactive"}">${fmtTR(it.val)}</span>
        </div>
      </div>
    `;
  }
  html += `</div>`;
  $("qcList").innerHTML = html;
}

function renderCross(enrichedEvents, enrichedProjects){
  const {names, mat} = crossParticipationTopProjects(enrichedEvents, enrichedProjects);
  if(names.length === 0){
    $("crossWrap").innerHTML = `<div class="empty">Yeterli veri yok.</div>`;
    return;
  }

  const max = Math.max(1, ...mat.flat());
  let html = `<div style="overflow:auto;">
  <table class="table" style="min-width:520px;">
    <thead><tr><th>Proje</th>`;
  for(const n of names){
    html += `<th>${escapeHtml(n.slice(0,10))}</th>`;
  }
  html += `</tr></thead><tbody>`;

  for(let i=0;i<names.length;i++){
    html += `<tr><td style="font-weight:1000;">${escapeHtml(names[i])}</td>`;
    for(let j=0;j<names.length;j++){
      const v = mat[i][j];
      const intensity = v / max;
      const bg = `rgba(6,182,212, ${0.06 + 0.34*intensity})`;
      html += `<td><div class="cell" style="height:30px;border-radius:10px;background:${bg};">${v||""}</div></td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table></div>`;
  $("crossWrap").innerHTML = html;
}

function renderActiveOps(enrichedEvents){
  const active = enrichedEvents
    .filter(e=>e.is_active===true)
    .sort((a,b)=>(b.attendee_count||0)-(a.attendee_count||0));

  $("activeCountTag").textContent = `Açık: ${fmtTR(active.length)}`;

  if(active.length === 0){
    $("activeEvents").innerHTML = `<div class="empty">Açık etkinlik yok.</div>`;
    return;
  }

  const baseUrl = location.origin + location.pathname.replace(/dashboard\.html$/,"");
  const checkinPath = "index.html"; 
  const makeQrLink = (code)=> `${baseUrl}${checkinPath}?event=${encodeURIComponent(code||"")}`;

  let html = ``;
  for(const e of active.slice(0,10)){
    const last = e.last_checkin_at ? new Date(e.last_checkin_at).toLocaleString("tr-TR") : "—";
    const qr = makeQrLink(e.event_code);
    html += `
      <div class="eventRow">
        <div class="eventLeft">
          <p class="eventTitle">${escapeHtml(e.event_title || "Etkinlik")}</p>
          <div class="eventSmall">
            <span>Kod: <b>${escapeHtml(e.event_code || "—")}</b></span>
            <span>Son check-in: <b>${escapeHtml(last)}</b></span>
          </div>
        </div>
        <div class="row">
          <button class="btn ghost small" data-copy="${escapeHtml(qr)}">QR link</button>
          <button class="btn small" data-open="${escapeHtml(e.id)}">Detay</button>
          <span class="badge good">${fmtTR(e.attendee_count)} kişi</span>
        </div>
      </div>
    `;
  }
  $("activeEvents").innerHTML = html;

  // bind
  $("activeEvents").querySelectorAll("[data-copy]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const txt = btn.getAttribute("data-copy");
      await navigator.clipboard.writeText(txt);
      setStatus("QR link kopyalandı");
      await sleep(900);
      setStatus("Hazır");
    });
  });
  $("activeEvents").querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      openDrawer(btn.getAttribute("data-open"), 'event');
    });
  });
}

// Filtreleme (CRM'siz)
function filterAndRenderProjectsHierarchy(enrichedEvents, enrichedProjects){
  const q = (state.search||"").trim().toLowerCase();
  const onlyActive = state.onlyActive;

  const filteredAttendances = []; // Filtrelenmiş kayıtlar (CSV için)
  const eventIdsInHierarchy = new Set();
  
  const byP = new Map(); 
  for(const e of enrichedEvents){
    if(onlyActive && !e.is_active) continue;

    const eventFilterMatch = (e.event_title||"").toLowerCase().includes(q)
      || (e.event_code||"").toLowerCase().includes(q);
      
    const projectFilterMatch = (state.byProject.get(e.project_id)?.project_name || "").toLowerCase().includes(q);

    if(q && !eventFilterMatch && !projectFilterMatch) continue;

    if(!byP.has(e.project_id)) byP.set(e.project_id, []);
    byP.get(e.project_id).push(e);
    eventIdsInHierarchy.add(e.id);
  }
  
  // Sadece hiyerarşide görünen etkinliklerin attendances kayıtlarını al
  for(const a of state.attendances){
      if(eventIdsInHierarchy.has(a.event_id)){
          filteredAttendances.push(a);
      }
  }
  state.filteredAttendances = filteredAttendances; // Global state'i güncelle
  
  let shownProjects = 0;
  let shownEvents = 0;

  const projOrder = [...enrichedProjects].sort((a,b)=>(b.attendee_count||0)-(a.attendee_count||0));

  let html = "";
  for(const p of projOrder){
    const evs = byP.get(p.id) || [];
    
    const projectFilterMatch = (p.project_name||"").toLowerCase().includes(q);

    if(q && !projectFilterMatch && evs.length === 0) continue; 
    if(!q && evs.length === 0) continue; 

    shownProjects++;
    shownEvents += evs.length;

    const last = p.last_checkin_at ? new Date(p.last_checkin_at).toLocaleString("tr-TR") : "—";
    const pTotal = fmtTR(p.attendee_count||0);

    html += `
      <div class="card projectCard">
        <div class="projectHead">
          <div style="min-width:0;">
            <h3 class="projectName">${escapeHtml(p.project_name || "Proje")}</h3>
            <div class="projectMeta">
              <span class="pill">${fmtTR(evs.length)} etkinlik (filtreli)</span>
              <span class="pill gray">${pTotal} check-in</span>
              <span class="pill gray">Son: ${escapeHtml(last)}</span>
            </div>
          </div>
        </div>
    `;

    if(evs.length===0){
      html += `<div class="empty">Bu filtrelerle etkinlik yok.</div>`;
    } else {
      html += `<div class="eventList">`;
      evs.sort((a,b)=>(b.attendee_count||0)-(a.attendee_count||0));
      for(const e of evs){
        const lastE = e.last_checkin_at ? new Date(e.last_checkin_at).toLocaleString("tr-TR") : "—";
        const active = e.is_active===true;
        const perf = performanceTag(e);
        html += `
          <div class="eventRow">
            <div class="eventLeft">
              <p class="eventTitle">${escapeHtml(e.event_title || "Etkinlik")}</p>
              <div class="eventSmall">
                <span>Kod: <b>${escapeHtml(e.event_code || "—")}</b></span>
                <span>Son check-in: <b>${escapeHtml(lastE)}</b></span>
                <span>Tekil kişi: <b>${fmtTR(e.uniq_people||0)}</b></span>
              </div>
              <div class="row" style="margin-top:8px;">
                <span class="pill ${perf.cls}">${perf.label}</span>
                ${e.qc.kvkkNo ? `<span class="pill bad">KVKK yok: ${fmtTR(e.qc.kvkkNo)}</span>` : `<span class="pill good">KVKK: OK</span>`}
                ${(e.qc.badEmail||e.qc.badPhone) ? `<span class="pill warn">Format: ${fmtTR(e.qc.badEmail)} mail, ${fmtTR(e.qc.badPhone)} tel</span>` : `<span class="pill good">Format: OK</span>`}
              </div>
            </div>
            <div class="row">
              <button class="btn ghost small" data-open="${escapeHtml(e.id)}">Detay</button>
              <span class="badge ${active ? "good":"inactive"}">${fmtTR(e.attendee_count)} kişi</span>
            </div>
          </div>
        `;
      }
      html += `</div>`;
    }

    html += `</div>`;
  }

  $("projects").innerHTML = html || `<div class="empty">Bu filtrelerle gösterilecek proje/etkinlik yok.</div>`;
  $("shownTag").textContent = `${fmtTR(shownProjects)} proje / ${fmtTR(shownEvents)} etkinlik`;
  $("csvCount").textContent = `${fmtTR(state.filteredAttendances.length)}`; 
  
  $("projects").querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", ()=> openDrawer(btn.getAttribute("data-open"), 'event'));
  });
}


/* =========================
   7) DRAWER (ETKİNLİK DETAYLARI)
========================= */

function showDrawer(show){
  if(show){
    drawerMask.classList.add("show");
    drawerMask.setAttribute("aria-hidden","false");
  } else {
    drawerMask.classList.remove("show");
    drawerMask.setAttribute("aria-hidden","true");
    drawerContent.innerHTML = ''; 
  }
}

drawerMask.addEventListener("click", (e)=>{
  if(e.target === drawerMask || e.target.id === "closeDrawerBtn") showDrawer(false);
});

// Katılımcı Profili (CRM) Fonksiyonları KALDIRILDI

// openDrawer fonksiyonu sadece Event Detay açacak
async function openDrawer(id, type) {
    if (type !== 'event') return; // Sadece etkinlik detayını aç

    const ev = state.byEvent.get(id);
    if(!ev){
        setStatus("Etkinlik bulunamadı");
        return;
    }
    
    // --- EVENT HEADER RENDER ---
    const headerHtml = `
        <div class="drawerHeader">
            <div style="min-width:0;">
                <div style="font-weight:1000;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(ev.event_title || "Etkinlik")}</div>
                <div class="muted" style="font-weight:900;font-size:12px;margin-top:4px;">Kod: ${ev.event_code || "—"} · Proje: ${state.byProject.get(ev.project_id)?.project_name || "—"}</div>
                <div class="row" style="margin-top:8px;">
                    <span class="pill" id="drawerPill">—</span>
                    <span class="pill gray" id="drawerLast">—</span>
                </div>
            </div>
            <div class="row">
                <button class="btn ghost small" id="csvEventBtn">CSV: bu etkinlik</button>
                <button class="btn small danger" id="closeDrawerBtn">Kapat</button>
            </div>
        </div>
        <div class="drawerBody" id="drawerBody">
            <div class="chipRow" style="margin-bottom:10px;">
                <div class="chip grow">
                    <span>Filtre</span>
                    <input id="drawerFilter" class="input" placeholder="ad / mail / telefon ara" />
                </div>
                <div class="status" id="drawerStatus">—</div>
            </div>

            <table class="table" id="drawerTable">
                <thead>
                    <tr>
                        <th style="width:26%">Ad Soyad</th>
                        <th style="width:22%">Mail</th>
                        <th style="width:18%">Telefon</th>
                        <th style="width:12%">KVKK</th>
                        <th style="width:22%">Tarih</th>
                    </tr>
                </thead>
                <tbody id="drawerTbody"></tbody>
            </table>
        </div>
    `;
    drawerContent.innerHTML = headerHtml;
    showDrawer(true);
    
    // --- VERİ ÇEKME ---
    const sinceISO = toISOStartDaysAgo(state.days);
    const res = await sb
        .from("attendances")
        .select("id, event_id, full_name, phone, email, kvkk_consent, created_at")
        .eq("event_id", id)
        .gte("created_at", sinceISO)
        .order("created_at", { ascending: false })
        .limit(2000);

    if(res.error){
        $("drawerStatus").textContent = "Hata: Veri okunamadı. RLS kontrol et.";
        $("drawerTbody").innerHTML = "";
        return;
    }

    const rows = res.data || [];
    state.drawer.event = ev;
    state.drawer.rows = rows;

    const last = rows[0]?.created_at ? new Date(rows[0].created_at).toLocaleString("tr-TR") : "—";
    $("drawerPill").textContent = `${fmtTR(rows.length)} kayıt`;
    $("drawerLast").textContent = `Son: ${last}`;
    $("drawerStatus").textContent = `${fmtTR(rows.length)} kayıt`;

    renderDrawerTable();
    
    // Olay bağlama
    $("closeDrawerBtn").addEventListener("click", ()=> showDrawer(false));
    $("csvEventBtn").addEventListener("click", ()=> downloadCSVForEvent(id));
    $("drawerFilter").addEventListener("input", renderDrawerTable);
}


function renderDrawerTable(){
  const q = ($("drawerFilter").value || "").trim().toLowerCase();
  const rows = state.drawer.rows || [];

  const filtered = q ? rows.filter(r=>{
    return (r.full_name||"").toLowerCase().includes(q)
      || normEmail(r.email).includes(q)
      || normPhone(r.phone).includes(q);
  }) : rows;

  $("drawerStatus").textContent = `${fmtTR(filtered.length)} kayıt`;

  const tr = (r)=>{
    const kv = r.kvkk_consent ? `<span class="pill good">Evet</span>` : `<span class="pill bad">Hayır</span>`; 
    
    // CRM linki KALDIRILDI
    const nameCell = escapeHtml(r.full_name||"");

    return `
      <tr>
        <td>${nameCell}</td>
        <td>${escapeHtml(normEmail(r.email)||"")}</td>
        <td>${escapeHtml(normPhone(r.phone)||"")}</td>
        <td>${kv}</td>
        <td>${escapeHtml(new Date(r.created_at).toLocaleString("tr-TR"))}</td>
      </tr>
    `;
  };

  $("drawerTbody").innerHTML = filtered.slice(0,1000).map(tr).join("") || `
    <tr><td colspan="5" class="muted" style="font-weight:950;">Kayıt yok.</td></tr>
  `;
}

/* =========================
   8) CSV (DİNAMİK FİLTERLİ İNDİRME)
========================= */

// Filtrelenmiş kayıtları indiren buton
$("csvFilteredBtn").addEventListener("click", ()=>{
  downloadCSV(state.filteredAttendances, `bbo_filtered_attendances_${state.days}gun.csv`);
});


function downloadCSV(rows, filename){
  // CSV header'dan 'participant_id' kaldırıldı
  const headers = ["event_id","full_name","email","phone","kvkk_consent","created_at"]; 
  const esc = (v)=>{
    const s = (v===null || v===undefined) ? "" : String(v);
    const safe = s.replaceAll('"','""');
    return `"${safe}"`;
  };

  const lines = [];
  lines.push(headers.join(","));
  for(const r of rows){
    lines.push([
      r.event_id,
      r.full_name,
      r.email,
      r.phone,
      r.kvkk_consent, 
      r.created_at
    ].map(esc).join(","));
  }

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function downloadCSVForEvent(eventId){
  const sinceISO = toISOStartDaysAgo(state.days);
  const res = await sb
    .from("attendances")
    .select("event_id, full_name, email, phone, kvkk_consent, created_at") // participant_id kaldırıldı
    .eq("event_id", eventId)
    .gte("created_at", sinceISO)
    .order("created_at", { ascending: false })
    .limit(5000);

  if(res.error){
    setStatus("CSV için veri çekilemedi");
    return;
  }
  const ev = state.byEvent.get(eventId);
  const name = (ev?.event_title || "event").replace(/[^\w\-]+/g,"_").slice(0,40);
  downloadCSV(res.data||[], `bbo_${name}_range.csv`);
}

/* =========================
   9) MAIN
========================= */
if($("range")) $("range").addEventListener("change", loadAll);
if($("search")) $("search").addEventListener("input", ()=>{
  state.search = $("search").value;
  filterAndRenderProjectsHierarchy(state._enrichedEvents, state._enrichedProjects);
  renderKPIs(state._aggregates); 
});
if($("onlyActive")) $("onlyActive").addEventListener("change", ()=>{
  state.onlyActive = $("onlyActive").checked;
  filterAndRenderProjectsHierarchy(state._enrichedEvents, state._enrichedProjects);
  renderKPIs(state._aggregates); 
});

async function loadAll(){
  try{
    state.days = Number($("range").value);
    state.search = $("search").value || "";
    state.onlyActive = $("onlyActive").checked;

    setStatus("Hazırlanıyor…");

    await fetchAll();

    const aggregates = buildAggregates();
    state._aggregates = aggregates; 
    
    state._enrichedEvents = aggregates.enrichedEvents;
    state._enrichedProjects = aggregates.enrichedProjects;

    renderKPIs(aggregates);
    renderDailyChart();
    renderHeatmap();
    renderTopEventsChart(aggregates.enrichedEvents);
    renderNewReturningChart();
    renderQC(aggregates.enrichedEvents);
    renderCross(aggregates.enrichedEvents, aggregates.enrichedProjects);

    renderActiveOps(aggregates.enrichedEvents);
    filterAndRenderProjectsHierarchy(aggregates.enrichedEvents, aggregates.enrichedProjects); 

    setStatus(`Yüklendi · ${fmtTR(state.attendances.length)} check-in (son ${state.days} gün)`);

  } catch(err){
    console.error(err);
    setStatus("Hata: Veri yüklenemedi. RLS, Auth veya Supabase bağlantınızı kontrol edin.");
    
    // Hata durumunda DOM temizliği
    $("kpiTotal").textContent = "Hata";
    $("kpiToday").textContent = "Hata";
    $("kpiActive").textContent = "Hata";
    
    $("projects").innerHTML = `<div class="empty">Veri yüklenemedi. Konsoldaki hata mesajını kontrol edin.</div>`;
    $("activeEvents").innerHTML = `<div class="empty">Veri yok.</div>`;
    $("qcList").innerHTML = `<div class="empty">Veri yok.</div>`;
    $("crossWrap").innerHTML = `<div class="empty">Veri yok.</div>`;
  }
}
</script>
</body>
</html>
