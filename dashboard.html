<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BBO | Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;font-family:system-ui;background:#f6fbff;color:#0b1a33;
}
.hidden{display:none}
.container{max-width:1200px;margin:auto;padding:16px}
.card{
  background:#fff;border-radius:16px;padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  margin-bottom:16px;
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.kpi h3{margin:0;font-size:14px;color:#64748b}
.kpi div{font-size:28px;font-weight:800}
button{
  background:#2563eb;color:#fff;border:none;
  padding:10px 14px;border-radius:12px;
  font-weight:700;cursor:pointer
}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #cbd5e1}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.event{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:8px}
.badge{background:#2563eb;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px}
.badge.gray{background:#94a3b8}
</style>
</head>

<body>

<!-- PIN -->
<div id="pinScreen" class="container">
  <div class="card" style="max-width:360px;margin:auto">
    <h2>Dashboard Girişi</h2>
    <input id="pinInput" type="password" placeholder="PIN">
    <button onclick="unlock()">Giriş</button>
    <div id="pinNote" style="color:#b91c1c;font-weight:700"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="container">

    <div class="topbar">
      <h2>Bir Bulut Olsam – Etkinlik Dashboard</h2>
      <button onclick="lock()">Kilitle</button>
    </div>

    <!-- KPI -->
    <div class="grid">
      <div class="card kpi"><h3>Toplam Katılımcı</h3><div id="kpiTotal">—</div></div>
      <div class="card kpi"><h3>Bugün Check-in</h3><div id="kpiToday">—</div></div>
      <div class="card kpi"><h3>Toplam Etkinlik</h3><div id="kpiEvents">—</div></div>
      <div class="card kpi"><h3>Aktif Etkinlik</h3><div id="kpiActive">—</div></div>
    </div>

    <!-- GRAFİKLER -->
    <div class="grid">
      <div class="card">
        <h3>Günlere Göre Katılım</h3>
        <canvas id="chartDays"></canvas>
      </div>
      <div class="card">
        <h3>Etkinlik Bazlı Katılım</h3>
        <canvas id="chartEvents"></canvas>
      </div>
    </div>

    <!-- PROJELER -->
    <div id="projects"></div>

  </div>
</div>

<script>
/* === AYARLAR === */
const DASHBOARD_PIN = "123456"; // DEĞİŞTİR
const SUPABASE_URL = "https://mkmzclarjfnwqnjexgwy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rbXpjbGFyamZud3FuamV4Z3d5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODk4MTksImV4cCI6MjA4MTM2NTgxOX0.r5RpP-r0P8fbnRP3rt_Bwn12CmMESbXSn86kg4FWzfM";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* === PIN === */
function unlock(){
  if(document.getElementById("pinInput").value !== DASHBOARD_PIN){
    document.getElementById("pinNote").innerText="PIN yanlış";
    return;
  }
  sessionStorage.setItem("bbo_ok","1");
  document.getElementById("pinScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  loadAll();
}
function lock(){
  sessionStorage.clear();
  location.reload();
}
if(sessionStorage.getItem("bbo_ok")==="1") unlock();

/* === LOAD === */
async function loadAll(){
  const { data } = await sb.from("project_event_counts").select("*");
  renderKPI(data);
  renderProjects(data);
  renderCharts(data);
}

/* === KPI === */
function renderKPI(rows){
  const total = rows.reduce((a,r)=>a+(r.attendee_count||0),0);
  document.getElementById("kpiTotal").innerText=total;
  document.getElementById("kpiEvents").innerText=new Set(rows.map(r=>r.event_id)).size;
  document.getElementById("kpiActive").innerText=rows.filter(r=>r.is_active).length;
  document.getElementById("kpiToday").innerText="—";
}

/* === PROJECTS === */
function renderProjects(rows){
  const root=document.getElementById("projects");
  root.innerHTML="";
  const map={};
  rows.forEach(r=>{
    if(!map[r.project_name]) map[r.project_name]=[];
    map[r.project_name].push(r);
  });

  for(const p in map){
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h3>${p}</h3>`;
    map[p].forEach(e=>{
      card.innerHTML+=`
        <div class="event">
          <strong>${e.event_title}</strong><br>
          <span class="badge ${e.is_active?"":"gray"}">${e.attendee_count} kişi</span>
        </div>`;
    });
    root.appendChild(card);
  }
}

/* === CHARTS === */
function renderCharts(rows){
  const byEvent={};
  rows.forEach(r=>{
    byEvent[r.event_title]=(byEvent[r.event_title]||0)+r.attendee_count;
  });

  new Chart(document.getElementById("chartEvents"),{
    type:"bar",
    data:{
      labels:Object.keys(byEvent),
      datasets:[{data:Object.values(byEvent),backgroundColor:"#2563eb"}]
    }
  });
}
</script>

</body>
</html>
